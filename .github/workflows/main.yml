name: Whisper Egypt Final Edition
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Prepare Assets
      run: |
        mkdir -p app/src/main/assets
        curl -L https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin -o app/src/main/assets/whisper-model.bin

    - name: Create Structure
      run: |
        mkdir -p app/src/main/cpp
        mkdir -p app/src/main/java/com/mohamedsaid/whisperoffline
        mkdir -p app/src/main/res/values
        echo '<resources><style name="AppTheme" parent="android:Theme.Material.Light.NoActionBar"/></resources>' > app/src/main/res/values/values.xml

    - name: Write Native Code
      run: |
        cat << 'EOF' > app/src/main/cpp/native-lib.cpp
        #include <jni.h>
        #include <string>
        #include "whisper.h"

        extern "C" JNIEXPORT jint JNICALL
        Java_com_mohamedsaid_whisperoffline_NativeWhisper_transcribeChunked(JNIEnv *env, jclass, jstring jM, jstring jA, jstring jO) {
            const char *mP = env->GetStringUTFChars(jM, 0);
            whisper_context_params cparams = whisper_context_default_params();
            struct whisper_context *ctx = whisper_init_from_file_with_params(mP, cparams);
            if (!ctx) return -1;
            whisper_full_params params = whisper_full_default_params(WHISPER_SAMPLING_GREEDY);
            params.n_threads = 4;
            params.language = "ar";
            params.initial_prompt = "يا هلا، بنكتب مصري عامي دلوقتي.";
            whisper_free(ctx);
            env->ReleaseStringUTFChars(jM, mP);
            return 0;
        }
        EOF

    - name: Write Java Source
      run: |
        cat <<EOF > app/src/main/java/com/mohamedsaid/whisperoffline/NativeWhisper.java
        package com.mohamedsaid.whisperoffline;
        public class NativeWhisper {
            static { System.loadLibrary("whisperoffline"); }
            public static native int transcribeChunked(String m, String a, String o);
        }
        EOF
        cat <<EOF > app/src/main/java/com/mohamedsaid/whisperoffline/MainActivity.java
        package com.mohamedsaid.whisperoffline;
        import android.app.Activity;
        import android.os.Bundle;
        import android.widget.TextView;
        public class MainActivity extends Activity {
            @Override protected void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                TextView tv = new TextView(this);
                tv.setText("Whisper Egypt: Ready\nDevice: Tab A7 Optimized");
                setContentView(tv);
            }
        }
        EOF
        cat <<EOF > app/src/main/AndroidManifest.xml
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <application android:label="WhisperEgypt" android:theme="@style/AppTheme">
                <activity android:name=".MainActivity" android:exported="true">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF

    - name: Setup Whisper Core
      run: |
        cd app/src/main/cpp
        git clone https://github.com/ggerganov/whisper.cpp.git
        cd whisper.cpp && git checkout v1.7.1
        cd ..
        cat <<EOF > CMakeLists.txt
        cmake_minimum_required(VERSION 3.22.1)
        project("whisperoffline")
        set(WHISPER_DIR \${CMAKE_CURRENT_SOURCE_DIR}/whisper.cpp)
        add_library(whisperoffline SHARED 
            native-lib.cpp 
            \${WHISPER_DIR}/src/whisper.cpp 
            \${WHISPER_DIR}/ggml/src/ggml.c 
            \${WHISPER_DIR}/ggml/src/ggml-alloc.c 
            \${WHISPER_DIR}/ggml/src/ggml-backend.c 
            \${WHISPER_DIR}/ggml/src/ggml-quants.c)
        target_include_directories(whisperoffline PRIVATE 
            \${WHISPER_DIR}/include 
            \${WHISPER_DIR}/src 
            \${WHISPER_DIR}/ggml/include)
        find_library(log-lib log)
        target_link_libraries(whisperoffline \${log-lib})
        EOF

    - name: Build Configuration
      run: |
        cat <<EOF > app/build.gradle
        plugins { id "com.android.application" }
        android {
            namespace "com.mohamedsaid.whisperoffline"
            compileSdk 34
            defaultConfig {
                applicationId "com.mohamedsaid.whisperoffline"
                minSdk 26
                targetSdk 34
                versionCode 1
                ndk { abiFilters "arm64-v8a" }
            }
            packagingOptions {
                jniLibs { useLegacyPackaging = true }
            }
            sourceSets { main { assets.srcDirs = ['src/main/assets'] } }
            externalNativeBuild { cmake { path "src/main/cpp/CMakeLists.txt" } }
        }
        EOF
        echo 'include ":app"' > settings.gradle
        echo 'buildscript { repositories { google(); mavenCentral() }; dependencies { classpath "com.android.tools.build:gradle:8.2.0" } }' > build.gradle
        echo 'allprojects { repositories { google(); mavenCentral() } }' >> build.gradle
        gradle wrapper --gradle-version 8.2

    - name: Build APK
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Sync Git
      if: always()
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        echo "app/src/main/assets/whisper-model.bin" >> .gitignore
        git add .
        git commit -m "fix: manifest and build config" || echo "done"
        git push origin ${{ github.ref_name }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Whisper-Egypt-APK
        path: app/build/outputs/apk/debug/app-debug.apk
